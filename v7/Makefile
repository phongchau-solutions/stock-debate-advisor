.PHONY: help install build deploy deploy-frontend test clean destroy

ENVIRONMENT ?= dev
AWS_REGION ?= us-east-1

help:
	@echo "Stock Debate Advisor v7 - Makefile"
	@echo "===================================="
	@echo ""
	@echo "Usage: make [target] [ENVIRONMENT=dev|prod]"
	@echo ""
	@echo "Targets:"
	@echo "  install           Install all dependencies"
	@echo "  build             Build all components (CDK, Frontend)"
	@echo "  deploy            Deploy infrastructure to AWS"
	@echo "  deploy-frontend   Deploy frontend to S3/CloudFront"
	@echo "  test              Run all tests"
	@echo "  logs              Tail Lambda logs"
	@echo "  destroy           Destroy AWS stack (BE CAREFUL!)"
	@echo "  clean             Clean build artifacts"
	@echo ""

install:
	@echo "ğŸ“¦ Installing dependencies..."
	cd cdk && npm install
	cd frontend && npm install
	@echo "âœ“ Dependencies installed"

build: install
	@echo "ğŸ”¨ Building components..."
	cd cdk && npm run build
	cd frontend && npm run build
	@echo "âœ“ Build complete"

deploy: build
	@echo "ğŸš€ Deploying to AWS ($(ENVIRONMENT))..."
	cd cdk && npm run cdk:deploy -- -c environment=$(ENVIRONMENT)
	@echo "âœ“ CDK stack deployed"

deploy-frontend: 
	@echo "ğŸ“¤ Deploying frontend..."
	./scripts/deploy-frontend.sh $(ENVIRONMENT)
	@echo "âœ“ Frontend deployed"

test:
	@echo "ğŸ§ª Running tests..."
	cd frontend && npm test -- --coverage
	cd ai-service && python -m pytest test/ -v || echo "No tests found"
	@echo "âœ“ Tests complete"

logs:
	@echo "ğŸ“‹ Tailing Lambda logs..."
	aws logs tail /aws/lambda/StockDebate-debate-orchestrator-$(ENVIRONMENT) --follow --region $(AWS_REGION)

synth:
	@echo "ğŸ“„ Synthesizing CloudFormation..."
	cd cdk && npm run cdk:synth
	@echo "âœ“ Synth complete - check cdk.out/"

diff:
	@echo "ğŸ“Š Showing infrastructure diff..."
	cd cdk && npm run cdk:diff -- -c environment=$(ENVIRONMENT)

destroy:
	@echo "âš ï¸  WARNING: This will delete all resources!"
	./scripts/destroy.sh $(ENVIRONMENT)

clean:
	@echo "ğŸ§¹ Cleaning build artifacts..."
	rm -rf cdk/lib cdk/dist cdk/cdk.out
	rm -rf frontend/dist frontend/build
	rm -rf ai-service/__pycache__ data_store/__pycache__
	@echo "âœ“ Clean complete"

.DEFAULT_GOAL := help
