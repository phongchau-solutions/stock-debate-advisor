# justfile - Command runner for monorepo

# Default recipe to display help information
default:
    @just --list

# Install all dependencies (frontend + backend)
install:
    @echo "Installing frontend dependencies..."
    pnpm install
    @echo "Installing Python dependencies for services..."
    cd services/debate-service && poetry install || echo "Skipping debate-service (not initialized)"
    cd services/data-service && poetry install || echo "Skipping data-service (not initialized)"
    cd services/ai-service && poetry install || echo "Skipping ai-service (not initialized)"
    cd services/analytics-service && poetry install || echo "Skipping analytics-service (not initialized)"
    cd services/user-service && poetry install || echo "Skipping user-service (not initialized)"
    cd services/notification-service && poetry install || echo "Skipping notification-service (not initialized)"
    @echo "✓ All dependencies installed"

# Run frontend in development mode
dev-frontend:
    pnpm --filter frontend dev

# Run all backend services in development mode
dev-services:
    @echo "Starting all backend services..."
    docker-compose -f infrastructure/docker/docker-compose.dev.yml up

# Run specific service
dev-service SERVICE:
    cd services/{{SERVICE}} && poetry run uvicorn app.main:app --reload --port 8000

# Run database migrations for all services
migrate:
    @echo "Running migrations for all services..."
    cd services/debate-service && poetry run alembic upgrade head || echo "Skipping debate-service migrations"
    cd services/data-service && poetry run alembic upgrade head || echo "Skipping data-service migrations"
    cd services/user-service && poetry run alembic upgrade head || echo "Skipping user-service migrations"
    @echo "✓ All migrations complete"

# Run tests for all services
test:
    @echo "Running frontend tests..."
    pnpm test || echo "Frontend tests not configured yet"
    @echo "Running backend tests..."
    cd services/debate-service && poetry run pytest || echo "Skipping debate-service tests"
    cd services/data-service && poetry run pytest || echo "Skipping data-service tests"
    cd services/ai-service && poetry run pytest || echo "Skipping ai-service tests"
    cd services/analytics-service && poetry run pytest || echo "Skipping analytics-service tests"
    cd services/user-service && poetry run pytest || echo "Skipping user-service tests"
    cd services/notification-service && poetry run pytest || echo "Skipping notification-service tests"

# Run linting for all code
lint:
    @echo "Linting frontend..."
    pnpm lint || echo "Frontend linting not configured yet"
    @echo "Linting backend..."
    find services -name "*.py" -not -path "*/venv/*" -not -path "*/.venv/*" | head -1 > /dev/null && \
    (cd services/debate-service && poetry run black . && poetry run flake8 || echo "Skipping debate-service linting")

# Format all code
format:
    @echo "Formatting frontend..."
    pnpm format || echo "Frontend formatting not configured yet"
    @echo "Formatting backend..."
    find services -name "*.py" -not -path "*/venv/*" -not -path "*/.venv/*" | xargs -r poetry run black || echo "Backend formatting not configured yet"

# Build all applications
build:
    pnpm build

# Build Docker images for all services
docker-build:
    @echo "Building Docker images..."
    docker build -t debate-service:latest -f services/debate-service/Dockerfile services/debate-service || echo "Skipping debate-service Docker build"
    docker build -t data-service:latest -f services/data-service/Dockerfile services/data-service || echo "Skipping data-service Docker build"
    docker build -t ai-service:latest -f services/ai-service/Dockerfile services/ai-service || echo "Skipping ai-service Docker build"

# Clean all build artifacts and dependencies
clean:
    @echo "Cleaning..."
    pnpm clean || echo "Nothing to clean in frontend"
    find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
    find . -type d -name ".pytest_cache" -exec rm -rf {} + 2>/dev/null || true
    find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
    find . -type d -name "dist" -exec rm -rf {} + 2>/dev/null || true
    find . -type d -name "build" -exec rm -rf {} + 2>/dev/null || true
    @echo "✓ Cleaned"

# Setup development environment
setup:
    @echo "Setting up development environment..."
    @just install
    cp .env.example .env || echo ".env.example not found, skipping"
    @echo "✓ Setup complete. Please update .env with your configuration."

# Start entire development environment
dev:
    @echo "Starting development environment..."
    @echo "Note: Run 'just dev-services' in one terminal and 'just dev-frontend' in another"
    @echo "Or use docker-compose to start all services together"
