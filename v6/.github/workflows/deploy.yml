name: Deploy to AWS

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'backend/**'
      - 'data-service/**'
      - 'ai-service/**'
      - 'frontend/**'
      - 'infra/**'
      - 'docker-compose.yml'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod

env:
  AWS_REGION: us-east-1
  REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Lint CDK
        working-directory: infra
        run: |
          npm install
          npm run lint || echo "Linting completed with warnings"
      
      - name: Run tests
        run: |
          npm run test --if-present || echo "No tests found"

  build-docker:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: build-and-test
    strategy:
      matrix:
        service:
          - backend
          - data-service
          - ai-service
          - frontend
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Login to ECR
        run: |
          aws ecr get-login-password --region ${{ env.AWS_REGION }} | \
            docker login --username AWS --password-stdin ${{ env.REGISTRY }}
      
      - name: Create ECR repository if not exists
        run: |
          aws ecr describe-repositories --repository-names stock-debate-${{ matrix.service }} \
            --region ${{ env.AWS_REGION }} 2>/dev/null || \
            aws ecr create-repository \
              --repository-name stock-debate-${{ matrix.service }} \
              --image-scanning-configuration scanOnPush=true \
              --region ${{ env.AWS_REGION }}
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./${{ matrix.service }}
          push: true
          tags: |
            ${{ env.REGISTRY }}/stock-debate-${{ matrix.service }}:latest
            ${{ env.REGISTRY }}/stock-debate-${{ matrix.service }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    name: Deploy to AWS
    runs-on: ubuntu-latest
    needs: build-docker
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    environment:
      name: ${{ github.ref == 'refs/heads/main' && 'production' || 'development' }}
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'infra/package-lock.json'
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Install CDK
        run: npm install -g aws-cdk
      
      - name: Install infra dependencies
        working-directory: infra
        run: npm install
      
      - name: Determine environment
        id: env
        run: |
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "environment=prod" >> $GITHUB_OUTPUT
          else
            echo "environment=dev" >> $GITHUB_OUTPUT
          fi
      
      - name: CDK bootstrap
        working-directory: infra
        run: |
          cdk bootstrap aws://${AWS_ACCOUNT_ID}/${AWS_REGION} || echo "Already bootstrapped"
        env:
          AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
      
      - name: CDK diff
        working-directory: infra
        run: cdk diff --context environment=${{ steps.env.outputs.environment }} || true
      
      - name: Deploy infrastructure
        working-directory: infra
        run: |
          cdk deploy \
            --require-approval=never \
            --context environment=${{ steps.env.outputs.environment }}

  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: [build-docker, deploy]
    if: always()
    steps:
      - name: Check deployment status
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "Deployment successful!"
          else
            echo "Deployment failed!"
            exit 1
          fi
      
      - name: Slack notification
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: 'Deployment ${{ needs.deploy.result }}'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
          fields: repo,message,commit,author
